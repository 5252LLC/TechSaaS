{% extends "admin/base.html" %}

{% block title %}TechSaaS - Security Anomaly Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-5">Security Anomaly Dashboard</h1>
      <p class="lead">Monitor and respond to detected security anomalies in real-time</p>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h5 class="card-title">Total Anomalies</h5>
          <h2 class="display-4" id="total-anomalies">-</h2>
          <p class="card-text">Detected in the last 30 days</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-title p-2">
          <h5>Critical & High Severity</h5>
          <h2 class="display-4" id="high-severity">-</h2>
          <p class="card-text">Requiring immediate attention</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning">
        <div class="card-body">
          <h5 class="card-title">Unreviewed</h5>
          <h2 class="display-4" id="unreviewed">-</h2>
          <p class="card-text">Pending review by security team</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h5 class="card-title">Resolved</h5>
          <h2 class="display-4" id="resolved">-</h2>
          <p class="card-text">Successfully addressed anomalies</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Trend Chart Row -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5>Anomaly Trend (Last 30 Days)</h5>
        </div>
        <div class="card-body">
          <canvas id="trend-chart" height="250"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5>Anomaly Types</h5>
        </div>
        <div class="card-body">
          <canvas id="type-chart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Anomaly Table -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5>Recent Anomalies</h5>
          <div>
            <button type="button" class="btn btn-outline-primary btn-sm" id="refresh-table" aria-label="Refresh anomaly list">
              <i class="fas fa-sync"></i> Refresh
            </button>
            <div class="dropdown d-inline-block ml-2">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="filter-dropdown" data-toggle="dropdown" aria-label="Filter options">
                Filter
              </button>
              <div class="dropdown-menu">
                <h6 class="dropdown-header">Severity</h6>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-severity" type="checkbox" value="critical" id="filter-critical" checked>
                    <label class="form-check-label" for="filter-critical">Critical</label>
                  </div>
                </div>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-severity" type="checkbox" value="high" id="filter-high" checked>
                    <label class="form-check-label" for="filter-high">High</label>
                  </div>
                </div>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-severity" type="checkbox" value="medium" id="filter-medium" checked>
                    <label class="form-check-label" for="filter-medium">Medium</label>
                  </div>
                </div>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-severity" type="checkbox" value="low" id="filter-low" checked>
                    <label class="form-check-label" for="filter-low">Low</label>
                  </div>
                </div>
                <div class="dropdown-divider"></div>
                <h6 class="dropdown-header">Status</h6>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-status" type="checkbox" value="new" id="filter-new" checked>
                    <label class="form-check-label" for="filter-new">New</label>
                  </div>
                </div>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-status" type="checkbox" value="under_review" id="filter-review" checked>
                    <label class="form-check-label" for="filter-review">Under Review</label>
                  </div>
                </div>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-status" type="checkbox" value="resolved" id="filter-resolved">
                    <label class="form-check-label" for="filter-resolved">Resolved</label>
                  </div>
                </div>
                <div class="dropdown-item">
                  <div class="form-check">
                    <input class="form-check-input filter-status" type="checkbox" value="false_positive" id="filter-false" checked>
                    <label class="form-check-label" for="filter-false">False Positive</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="anomalies-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Timestamp</th>
                  <th>Type</th>
                  <th>Severity</th>
                  <th>User ID</th>
                  <th>Source IP</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="anomalies-body">
                <tr>
                  <td colspan="8" class="text-center">Loading anomalies...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between">
            <div>
              <select class="custom-select custom-select-sm" id="page-size" aria-label="Number of items per page" title="Select number of items per page">
                <option value="10">10 per page</option>
                <option value="25">25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
              </select>
            </div>
            <nav>
              <ul class="pagination" id="pagination">
                <!-- Pagination controls will be injected here -->
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Anomaly Detail Modal -->
<div class="modal fade" id="anomaly-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="anomaly-modal-title">Anomaly Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label"><strong>Anomaly ID:</strong></label>
              <div id="detail-id"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Timestamp:</strong></label>
              <div id="detail-timestamp"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Type:</strong></label>
              <div id="detail-type"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Severity:</strong></label>
              <div id="detail-severity"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label"><strong>User ID:</strong></label>
              <div id="detail-user"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Source IP:</strong></label>
              <div id="detail-ip"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>API Endpoint:</strong></label>
              <div id="detail-endpoint"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Status:</strong></label>
              <div id="detail-status"></div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label class="form-label"><strong>Response Actions:</strong></label>
              <div id="detail-actions"></div>
            </div>
            <div class="mb-3">
              <label class="form-label"><strong>Details:</strong></label>
              <pre id="detail-details" class="p-2 bg-light border rounded"></pre>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="mb-3">
              <label for="anomaly-comments" class="form-label"><strong>Review Comments:</strong></label>
              <textarea class="form-control" id="anomaly-comments" rows="3"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-info" id="status-review" aria-label="Mark anomaly as under review">Mark Under Review</button>
        <button type="button" class="btn btn-success" id="status-resolved" aria-label="Mark anomaly as resolved">Mark Resolved</button>
        <button type="button" class="btn btn-warning" id="status-false" aria-label="Mark anomaly as false positive">Mark False Positive</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
<script>
  // Dashboard data
  let dashboardData = null;
  let anomaliesData = [];
  
  // Pagination state
  let currentPage = 1;
  let pageSize = 10;
  let totalPages = 1;
  
  // Filters state
  let filters = {
    severity: ["critical", "high", "medium", "low"],
    status: ["new", "under_review", "false_positive"]
  };
  
  // Initialize dashboard
  $(document).ready(function() {
    // Load initial dashboard data
    loadDashboardData();
    
    // Load initial anomalies
    loadAnomalies();
    
    // Set up event listeners
    setupEventListeners();
  });
  
  function setupEventListeners() {
    // Refresh button
    $('#refresh-table').click(function() {
      loadAnomalies();
    });
    
    // Page size selector
    $('#page-size').change(function() {
      pageSize = parseInt($(this).val());
      currentPage = 1;
      loadAnomalies();
    });
    
    // Filter checkboxes
    $('.filter-severity').change(function() {
      filters.severity = $('.filter-severity:checked').map(function() {
        return $(this).val();
      }).get();
      currentPage = 1;
      loadAnomalies();
    });
    
    $('.filter-status').change(function() {
      filters.status = $('.filter-status:checked').map(function() {
        return $(this).val();
      }).get();
      currentPage = 1;
      loadAnomalies();
    });
    
    // Status update buttons
    $('#status-review').click(function() {
      updateAnomalyStatus('under_review');
    });
    
    $('#status-resolved').click(function() {
      updateAnomalyStatus('resolved');
    });
    
    $('#status-false').click(function() {
      updateAnomalyStatus('false_positive');
    });
  }
  
  function loadDashboardData() {
    $.ajax({
      url: '/api/v1/security/anomalies/dashboard',
      method: 'GET',
      success: function(data) {
        dashboardData = data;
        updateDashboardUI();
      },
      error: function(xhr) {
        console.error('Error loading dashboard data:', xhr.responseText);
        showErrorAlert('Failed to load dashboard data. Please try again.');
      }
    });
  }
  
  function updateDashboardUI() {
    if (!dashboardData) return;
    
    // Update stat cards
    $('#total-anomalies').text(dashboardData.counts.total);
    $('#high-severity').text(
      (dashboardData.counts.by_severity.critical || 0) + 
      (dashboardData.counts.by_severity.high || 0)
    );
    $('#unreviewed').text(dashboardData.counts.by_status.new || 0);
    $('#resolved').text(dashboardData.counts.by_status.resolved || 0);
    
    // Create trend chart
    const trendCtx = document.getElementById('trend-chart').getContext('2d');
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: dashboardData.chart_data.map(d => d.date),
        datasets: [{
          label: 'Anomalies',
          data: dashboardData.chart_data.map(d => d.count),
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          xAxes: [{
            gridLines: {
              display: false
            },
            ticks: {
              maxTicksLimit: 10
            }
          }],
          yAxes: [{
            ticks: {
              beginAtZero: true,
              precision: 0
            }
          }]
        }
      }
    });
    
    // Create type chart
    const typeCtx = document.getElementById('type-chart').getContext('2d');
    const typeLabels = Object.keys(dashboardData.counts.by_type);
    const typeData = Object.values(dashboardData.counts.by_type);
    
    // Generate colors for each type
    const typeColors = typeLabels.map((_, i) => {
      const hue = (i * 137) % 360; // Use golden ratio to spread colors
      return `hsl(${hue}, 70%, 60%)`;
    });
    
    new Chart(typeCtx, {
      type: 'doughnut',
      data: {
        labels: typeLabels.map(formatAnomalyType),
        datasets: [{
          data: typeData,
          backgroundColor: typeColors
        }]
      },
      options: {
        responsive: true,
        legend: {
          position: 'right',
          labels: {
            boxWidth: 12
          }
        }
      }
    });
  }
  
  function loadAnomalies() {
    // Show loading state
    $('#anomalies-body').html('<tr><td colspan="8" class="text-center">Loading anomalies...</td></tr>');
    
    // Build query parameters
    let queryParams = new URLSearchParams();
    queryParams.append('limit', pageSize);
    
    if (filters.severity && filters.severity.length > 0) {
      queryParams.append('severity', filters.severity.join(','));
    }
    
    if (filters.status && filters.status.length > 0 && filters.status.length < 4) {
      // Only add status filter if not all statuses are selected
      queryParams.append('status', filters.status.join(','));
    }
    
    $.ajax({
      url: '/api/v1/security/anomalies?' + queryParams.toString(),
      method: 'GET',
      success: function(data) {
        anomaliesData = data;
        updateAnomaliesTable();
      },
      error: function(xhr) {
        console.error('Error loading anomalies:', xhr.responseText);
        $('#anomalies-body').html('<tr><td colspan="8" class="text-center text-danger">Failed to load anomalies. Please try again.</td></tr>');
      }
    });
  }
  
  function updateAnomaliesTable() {
    if (!anomaliesData || anomaliesData.length === 0) {
      $('#anomalies-body').html('<tr><td colspan="8" class="text-center">No anomalies found matching the current filters.</td></tr>');
      updatePagination(0);
      return;
    }
    
    // Calculate pagination
    totalPages = Math.ceil(anomaliesData.length / pageSize);
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, anomaliesData.length);
    const pageData = anomaliesData.slice(startIndex, endIndex);
    
    // Generate table rows
    let tableHtml = '';
    pageData.forEach(anomaly => {
      const timestamp = new Date(anomaly.timestamp).toLocaleString();
      
      tableHtml += `<tr>
        <td><a href="#" class="anomaly-detail-link" data-id="${anomaly.anomaly_id}">${anomaly.anomaly_id.substring(0, 8)}...</a></td>
        <td>${timestamp}</td>
        <td>${formatAnomalyType(anomaly.anomaly_type)}</td>
        <td>${getSeverityBadge(anomaly.severity)}</td>
        <td>${anomaly.user_id || '-'}</td>
        <td>${anomaly.source_ip || '-'}</td>
        <td>${getStatusBadge(anomaly.status)}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary anomaly-detail-btn" data-id="${anomaly.anomaly_id}">
            <i class="fas fa-search"></i> Details
          </button>
        </td>
      </tr>`;
    });
    
    $('#anomalies-body').html(tableHtml);
    updatePagination(anomaliesData.length);
    
    // Set up event listeners for detail buttons
    $('.anomaly-detail-btn, .anomaly-detail-link').click(function() {
      const anomalyId = $(this).data('id');
      showAnomalyDetails(anomalyId);
    });
  }
  
  function updatePagination(totalItems) {
    totalPages = Math.ceil(totalItems / pageSize);
    
    let paginationHtml = '';
    
    // Previous button
    paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
    </li>`;
    
    // Page numbers
    const maxPages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages, startPage + maxPages - 1);
    
    if (endPage - startPage + 1 < maxPages) {
      startPage = Math.max(1, endPage - maxPages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
        <a class="page-link" href="#" data-page="${i}">${i}</a>
      </li>`;
    }
    
    // Next button
    paginationHtml += `<li class="page-item ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}">
      <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
    </li>`;
    
    $('#pagination').html(paginationHtml);
    
    // Set up event listeners for pagination
    $('.page-link').click(function(e) {
      e.preventDefault();
      if ($(this).parent().hasClass('disabled')) return;
      
      currentPage = parseInt($(this).data('page'));
      updateAnomaliesTable();
    });
  }
  
  function showAnomalyDetails(anomalyId) {
    $.ajax({
      url: `/api/v1/security/anomalies/${anomalyId}`,
      method: 'GET',
      success: function(anomaly) {
        // Populate modal fields
        $('#detail-id').text(anomaly.anomaly_id);
        $('#detail-timestamp').text(new Date(anomaly.timestamp).toLocaleString());
        $('#detail-type').text(formatAnomalyType(anomaly.anomaly_type));
        $('#detail-severity').html(getSeverityBadge(anomaly.severity));
        $('#detail-user').text(anomaly.user_id || 'N/A');
        $('#detail-ip').text(anomaly.source_ip || 'N/A');
        $('#detail-endpoint').text(anomaly.api_endpoint || 'N/A');
        $('#detail-status').html(getStatusBadge(anomaly.status));
        
        // Show response actions
        const actionsHtml = anomaly.response_actions.map(action => 
          `<span class="badge badge-info mr-1">${formatResponseAction(action)}</span>`
        ).join(' ');
        $('#detail-actions').html(actionsHtml || 'None');
        
        // Format details as JSON
        $('#detail-details').text(JSON.stringify(anomaly.details, null, 2));
        
        // Show existing comments
        $('#anomaly-comments').val(anomaly.review_comments || '');
        
        // Store anomaly ID for status updates
        $('#anomaly-modal').data('anomaly-id', anomaly.anomaly_id);
        
        // Show modal
        $('#anomaly-modal').modal('show');
      },
      error: function(xhr) {
        console.error('Error loading anomaly details:', xhr.responseText);
        showErrorAlert('Failed to load anomaly details. Please try again.');
      }
    });
  }
  
  function updateAnomalyStatus(status) {
    const anomalyId = $('#anomaly-modal').data('anomaly-id');
    const comments = $('#anomaly-comments').val();
    
    if (!anomalyId) return;
    
    $.ajax({
      url: `/api/v1/security/anomalies/${anomalyId}/status`,
      method: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify({
        status: status,
        comments: comments
      }),
      success: function() {
        $('#anomaly-modal').modal('hide');
        showSuccessAlert(`Anomaly status updated to ${formatStatus(status)}`);
        
        // Reload data
        loadDashboardData();
        loadAnomalies();
      },
      error: function(xhr) {
        console.error('Error updating anomaly status:', xhr.responseText);
        showErrorAlert('Failed to update anomaly status. Please try again.');
      }
    });
  }
  
  // Utility functions
  function formatAnomalyType(type) {
    if (!type) return 'Unknown';
    
    return type
      .replace(/_/g, ' ')
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }
  
  function formatResponseAction(action) {
    if (!action) return 'Unknown';
    
    return action
      .replace(/_/g, ' ')
      .split(' ')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }
  
  function formatStatus(status) {
    if (!status) return 'Unknown';
    
    switch (status) {
      case 'new': return 'New';
      case 'under_review': return 'Under Review';
      case 'resolved': return 'Resolved';
      case 'false_positive': return 'False Positive';
      default: return status;
    }
  }
  
  function getSeverityBadge(severity) {
    if (!severity) return '<span class="badge badge-secondary">Unknown</span>';
    
    switch (severity) {
      case 'critical':
        return '<span class="badge badge-danger">Critical</span>';
      case 'high':
        return '<span class="badge badge-warning">High</span>';
      case 'medium':
        return '<span class="badge badge-info">Medium</span>';
      case 'low':
        return '<span class="badge badge-success">Low</span>';
      case 'info':
        return '<span class="badge badge-secondary">Info</span>';
      default:
        return `<span class="badge badge-secondary">${severity}</span>`;
    }
  }
  
  function getStatusBadge(status) {
    if (!status) return '<span class="badge badge-secondary">Unknown</span>';
    
    switch (status) {
      case 'new':
        return '<span class="badge badge-danger">New</span>';
      case 'under_review':
        return '<span class="badge badge-warning">Under Review</span>';
      case 'resolved':
        return '<span class="badge badge-success">Resolved</span>';
      case 'false_positive':
        return '<span class="badge badge-secondary">False Positive</span>';
      default:
        return `<span class="badge badge-secondary">${status}</span>`;
    }
  }
  
  function showSuccessAlert(message) {
    const alertHtml = `
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    `;
    
    // Add alert to the top of the page
    $('body').prepend(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      $('.alert').alert('close');
    }, 5000);
  }
  
  function showErrorAlert(message) {
    const alertHtml = `
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    `;
    
    // Add alert to the top of the page
    $('body').prepend(alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      $('.alert').alert('close');
    }, 5000);
  }
</script>
{% endblock %}
